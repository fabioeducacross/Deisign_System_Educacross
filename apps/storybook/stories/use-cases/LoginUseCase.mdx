import { Meta } from '@storybook/blocks';
import { MermaidDiagram } from '../../src/components/MermaidDiagram';

<Meta title="Casos de Uso/Autenticação/UC-001: Login de Usuário" />

# UC-001: Login de Usuário

## Informações Gerais

| Atributo | Valor |
|----------|-------|
| **ID** | UC-001 |
| **Nome** | Login de Usuário |
| **Ator principal** | Usuário não autenticado |
| **Objetivo** | Autenticar usuário e conceder acesso ao sistema |
| **Prioridade** | Alta (P1) |
| **Status** | Implementado |
| **Complexidade** | Baixa |

---

## Pré-condições

1. Usuário possui conta cadastrada no sistema
2. Email foi confirmado (RN-VAL-003)
3. Conta não está bloqueada
4. Sistema está disponível

---

## Pós-condições

### Sucesso
- Usuário autenticado recebe token JWT
- Sessão ativa é criada no servidor
- Usuário é redirecionado para dashboard apropriado ao seu papel
- Log de login é registrado

### Falha
- Número de tentativas falhas é incrementado
- Log de tentativa falha é registrado
- Após 3 tentativas: CAPTCHA é solicitado (RN-AUTH-006)
- Após 5 tentativas: conta bloqueada por 15 minutos (RN-AUTH-006)

---

## Fluxo Principal

<MermaidDiagram chart={`
sequenceDiagram
    actor U as Usuário
    participant F as Frontend
    participant B as Backend
    participant DB as Database
    participant S as Session Store
    
    U->>F: 1. Acessa página de login
    F->>U: 2. Exibe formulário
    U->>F: 3. Preenche email e senha
    F->>F: 4. Valida formato (client-side)
    F->>B: 5. POST /api/auth/login
    B->>DB: 6. Busca usuário por email
    DB->>B: 7. Retorna dados do usuário
    B->>B: 8. Valida senha (hash)
    B->>DB: 9. Verifica status da conta
    B->>B: 10. Gera token JWT
    B->>S: 11. Cria sessão
    B->>DB: 12. Registra log de acesso
    B->>F: 13. Retorna token + dados usuário
    F->>F: 14. Armazena token (localStorage)
    F->>U: 15. Redireciona para dashboard
`} />

**Passos detalhados**:

1. **Usuário acessa página de login**
   - URL: `/login`
   - Pode vir de redirect após tentar acessar rota protegida

2. **Sistema exibe formulário**
   - Campos: Email, Senha
   - Botão "Entrar"
   - Links: "Esqueci minha senha", "Criar conta"

3. **Usuário preenche credenciais**
   - Email: Validação de formato em tempo real
   - Senha: Campo mascarado com opção de visualizar

4. **Validação client-side**
   - Email deve ter formato válido
   - Senha não pode estar vazia
   - Botão desabilitado se inválido

5. **Requisição ao backend**
   ```json
   POST /api/auth/login
   {
     "email": "usuario@educacross.com",
     "password": "Senha@123"
   }
   ```

6-7. **Busca de usuário**
   - Query: `SELECT * FROM users WHERE email = ? AND active = true`
   - Se não encontrado: erro 401

8. **Validação de senha**
   - Compara hash armazenado com hash da senha enviada
   - Usa bcrypt com salt
   - Se inválida: erro 401

9. **Verificação de status**
   - Conta ativa? (não desativada)
   - Conta desbloqueada? (sem bloqueio temporário)
   - Email confirmado?

10. **Geração de token**
    ```typescript
    const payload = {
      userId: user.id,
      email: user.email,
      role: user.role,
      iat: Date.now(),
      exp: Date.now() + (30 * 60 * 1000) // 30 minutos
    };
    const token = jwt.sign(payload, SECRET_KEY);
    ```

11. **Criação de sessão**
    - Armazena em Redis: `session:{userId}:{timestamp}`
    - TTL: 30 minutos (renovável)

12. **Log de acesso**
    ```json
    {
      "userId": 123,
      "action": "login",
      "ip": "192.168.1.1",
      "userAgent": "Mozilla/5.0...",
      "timestamp": "2026-01-14T10:30:00Z",
      "status": "success"
    }
    ```

13. **Resposta de sucesso**
    ```json
    {
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "user": {
        "id": 123,
        "name": "João Silva",
        "email": "joao@educacross.com",
        "role": "student",
        "avatar": "https://..."
      },
      "expiresIn": 1800
    }
    ```

14. **Armazenamento do token**
    - `localStorage.setItem('authToken', token)`
    - Header de requisições: `Authorization: Bearer {token}`

15. **Redirecionamento**
    - Aluno → `/dashboard/aluno`
    - Professor → `/dashboard/professor`
    - Coordenador → `/dashboard/coordenador`
    - Admin → `/admin/painel`

---

## Fluxos Alternativos

### FA-01: Credenciais Inválidas

<MermaidDiagram chart={`
flowchart LR
    A[Enviar credenciais] --> B{Válidas?}
    B -->|Não| C[Incrementar tentativas]
    C --> D{Tentativas < 3?}
    D -->|Sim| E[Retornar erro 401]
    E --> F[Mostrar mensagem]
    F --> G[Usuário tenta novamente]
    D -->|Não| H[Exigir CAPTCHA]
    H --> I{Tentativas < 5?}
    I -->|Sim| E
    I -->|Não| J[Bloquear conta 15 min]
    J --> K[Enviar email de bloqueio]
`} />

**Mensagens**:
- Tentativa 1-2: "Email ou senha incorretos. Tente novamente."
- Tentativa 3+: "Email ou senha incorretos. Resolva o CAPTCHA abaixo."
- Tentativa 5+: "Conta bloqueada por 15 minutos devido a múltiplas tentativas. Um email foi enviado para você."

### FA-02: Conta Desativada

**Condição**: Usuário existe mas conta foi desativada

**Fluxo**:
1. Sistema detecta `active = false`
2. Retorna erro 403 Forbidden
3. Mensagem: "Sua conta foi desativada. Entre em contato com o suporte."

### FA-03: Email Não Confirmado

**Condição**: Usuário cadastrado mas não confirmou email

**Fluxo**:
1. Sistema detecta `emailConfirmed = false`
2. Retorna erro 403 com flag `emailNotConfirmed`
3. Frontend exibe mensagem com opção de reenviar email
4. Usuário pode solicitar novo email de confirmação

### FA-04: Primeiro Acesso (Onboarding)

**Condição**: `firstLogin = true`

**Fluxo**:
1. Login bem-sucedido
2. Sistema detecta flag de primeiro acesso
3. Redireciona para `/onboarding` ao invés de dashboard
4. Após completar onboarding, `firstLogin` é marcado como `false`

### FA-05: MFA Obrigatório

**Condição**: Usuário tem MFA ativado ou papel exige MFA (admin)

<MermaidDiagram chart={`
sequenceDiagram
    actor U as Usuário
    participant F as Frontend
    participant B as Backend
    participant MFA as MFA Service
    
    U->>F: 1. Login com credenciais
    F->>B: 2. POST /api/auth/login
    B->>B: 3. Valida credenciais (OK)
    B->>B: 4. Detecta MFA ativo
    B->>MFA: 5. Gera código 2FA
    MFA->>B: 6. Código gerado
    B->>U: 7. Envia código por email/SMS
    B->>F: 8. Retorna status "MFA_REQUIRED"
    F->>U: 9. Exibe campo para código
    U->>F: 10. Digita código
    F->>B: 11. POST /api/auth/verify-mfa
    B->>MFA: 12. Valida código
    MFA->>B: 13. Código válido
    B->>F: 14. Retorna token JWT
    F->>U: 15. Redireciona para dashboard
`} />

---

## Fluxos de Exceção

### FE-01: Sistema Indisponível

**Condição**: Backend não responde ou está em manutenção

**Tratamento**:
- Frontend detecta timeout após 10 segundos
- Exibe mensagem: "Sistema temporariamente indisponível. Tente novamente em alguns minutos."
- Registra erro no Sentry para monitoramento

### FE-02: Token Inválido ou Expirado

**Condição**: Usuário tenta acessar com token expirado

**Tratamento**:
1. Backend retorna 401 Unauthorized
2. Frontend intercepta resposta
3. Remove token do localStorage
4. Redireciona para `/login` com mensagem: "Sua sessão expirou. Faça login novamente."

### FE-03: Múltiplas Sessões

**Condição**: Usuário loga em mais de 3 dispositivos (limite RN-AUTH-004)

**Tratamento**:
1. Sistema detecta limite excedido
2. Exibe mensagem: "Você atingiu o limite de 3 sessões simultâneas. Deseja encerrar as outras sessões?"
3. Opções: "Sim, encerrar outras" ou "Cancelar"
4. Se confirmado: invalida todas as outras sessões

---

## Regras de Negócio Aplicadas

| ID | Descrição | Validação |
|----|-----------|-----------|
| RN-AUTH-001 | Senha complexa | Backend valida hash |
| RN-AUTH-004 | Tempo de sessão 30 min | Token JWT com exp |
| RN-AUTH-006 | Bloqueio por tentativas | Backend incrementa contador |
| RN-VAL-002 | Email válido | Frontend + Backend |
| RN-VAL-003 | Email confirmado | Backend verifica flag |

---

## Segurança

### Proteções Implementadas

1. **HTTPS obrigatório**
   - Todas as requisições via TLS 1.3+
   
2. **Rate limiting**
   - 10 tentativas/minuto por IP
   - 5 tentativas/minuto por email

3. **Proteção contra timing attack**
   - Resposta sempre demora o mesmo tempo (200ms) independente de erro

4. **CAPTCHA após tentativas**
   - Google reCAPTCHA v3
   - Score mínimo: 0.5

5. **Headers de segurança**
   ```
   Content-Security-Policy: default-src 'self'
   X-Content-Type-Options: nosniff
   X-Frame-Options: DENY
   X-XSS-Protection: 1; mode=block
   ```

---

## Dados de Teste

### Casos de Teste Válidos

```typescript
// CT-001: Login bem-sucedido (aluno)
{
  email: "aluno@test.com",
  password: "Senha@123",
  expected: {
    status: 200,
    redirectTo: "/dashboard/aluno"
  }
}

// CT-002: Login bem-sucedido (professor)
{
  email: "professor@test.com",
  password: "Prof@2026",
  expected: {
    status: 200,
    redirectTo: "/dashboard/professor"
  }
}
```

### Casos de Teste Inválidos

```typescript
// CT-003: Senha incorreta
{
  email: "aluno@test.com",
  password: "SenhaErrada",
  expected: {
    status: 401,
    message: "Email ou senha incorretos"
  }
}

// CT-004: Email não existe
{
  email: "inexistente@test.com",
  password: "Senha@123",
  expected: {
    status: 401,
    message: "Email ou senha incorretos"
  }
}

// CT-005: Conta bloqueada
{
  email: "bloqueado@test.com",
  password: "Senha@123",
  expected: {
    status: 403,
    message: "Conta bloqueada por 15 minutos"
  }
}
```

---

## Performance

| Métrica | Meta | Medição Atual |
|---------|------|---------------|
| Tempo de resposta (p95) | < 200ms | 180ms |
| Tempo de resposta (p99) | < 500ms | 420ms |
| Taxa de erro | < 0.1% | 0.08% |
| Throughput | > 1000 req/s | 1200 req/s |

---

## Dependências

### Internas
- **Componentes**: [Input](../?path=/docs/componentes-input--docs), [Button](../?path=/docs/componentes-button--docs)
- **Regras**: [Autenticação](../?path=/docs/regras-de-negócio-autenticação--docs)

### Externas
- bcrypt (hash de senha)
- jsonwebtoken (JWT)
- Redis (sessões)
- SendGrid (email)

---

## Histórico de Mudanças

| Versão | Data | Autor | Mudança |
|--------|------|-------|---------|
| 1.0 | 2025-01-10 | Equipe Backend | Versão inicial |
| 1.1 | 2025-12-15 | Segurança | Adicionado MFA obrigatório para admin |
| 1.2 | 2026-01-05 | UX | Melhorado feedback de erros |

---

**Última atualização**: 14 de janeiro de 2026  
**Responsável**: Equipe de Backend  
**Revisor**: Equipe de Segurança  
**Próxima revisão**: Abril 2026
